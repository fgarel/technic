\documentclass{article}
% Les paramètres de connexion
\texdbconnection{postgres, localhost, fred, fred, exemples-lbd}

% Création de la table notes , si elle existe déjà , on ajoute # ou un
% autre symbole devant la première ligne et on commente si ce n ’ est
% déjà fait .
\texdbinstruction {
  CREATE TABLE notes (
    id integer primary key,
    nom varchar(30),
    dev1 numeric(3,1),
    dev2 numeric(3,1),
    dev3 numeric(3,1),
    moy numeric(4,2),
    rang integer)}

% On remplit la table , calcule la moyenne et le rang .
% Création de la table annexe
\texdbinstruction{CREATE TABLE temp (id integer, nom varchar(30), note numeric(3,1))}
% On remplit la table,
\texdbinstruction[(1,2,3)]{BEGIN;
  DELETE FROM temp;
  COPY temp FROM <chemin >/dev##1;
  UPDATE notes SET dev##1 = temp.note
    FROM temp
    WHERE notes.num = temp.num ;
  COMMIT}
% on calcule de la moyenne et le rang .
\texdbinstruction { BEGIN ;
  UPDATE notes SET moy = (dev1+dev2+dev3)/3;
  UPDATE notes SET rang =
     (SELECT count(w2.moy)+1 FROM notes w2 WHERE w2.moy>notes.moy);
  COMMIT}

% Requête
\texdbdef{##q}{SELECT %
   nom,
   dev1,
   dev2,
   dev3,
   moy,
   rang
FROM notes ORDER by rang }

% Requête pour les moyennes de classe
\texdbdef{##m}{SELECT
  round(avg(dev1),1) as moydev1,
  round(avg(dev2),1) as moydev2,
  round(avg(dev3),1) as moydev3,
  round(avg(moy),1) as moyg
FROM notes }

\begin{document}
\begin{tabular}{|c|l|c|*{3}{c|}}
\hline
 Rang&Nom&moy&Dev1&Dev2&Dev3\\
\hline
% LES NOTES
\texdbfor{## q}{row.rang&row.nom&row.moy&row.dev1&row.dev2&row.dev3\\}
\hline
% LES MOYENNES
\texdbfor{##m}{&&row.moyg&row.moydev1&row.moydev2&row.moydev3\\}
\hline
\end{tabular}
\end{document}